const Logger = (() => {
    const DB_NAME = 'logDB';
    const STORE_NAME = 'logs';
    const DB_VERSION = 1;
    let db;
    let isOpen = false;

    // Mở hoặc tạo IndexedDB
    function openDB() {
        return new Promise((resolve, reject) => {
            if (db) return resolve(db);

            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onupgradeneeded = (event) => {
                const database = event.target.result;
                if (!database.objectStoreNames.contains(STORE_NAME)) {
                    database.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };

            request.onerror = (event) => {
                reject(event.target.error);
            };
        });
    }

    // Thêm log vào IndexedDB
    async function addLog(message, level = 'info') {
        try {
            const database = await openDB();
            const tx = database.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);
            const logEntry = {
                message,
                level,
                timestamp: new Date().toISOString(),
            };
            store.add(logEntry);
            await tx.complete;
        } catch (error) {
            console.error('Logger: Failed to write log to IndexedDB', error);
        }
    }

    // Lấy tất cả log từ IndexedDB
    async function getAllLogs() {
        const database = await openDB();
        return new Promise((resolve, reject) => {
            const tx = database.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const request = store.getAll();

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    const MAP_COLORS = {
        'INFO': 'cyan',
        'WARN': 'yellow',
        'ERROR': 'red',
        'DEBUG': 'white',
    }

    async function clearAllLogs() {
        const database = await openDB();
        return new Promise((resolve, reject) => {
            const tx = database.transaction(STORE_NAME, 'readwrite');
            const store = tx.objectStore(STORE_NAME);

            const request = store.clear();  // xóa toàn bộ dữ liệu trong store

            request.onsuccess = () => resolve(true);
            request.onerror = () => reject(request.error);
        });
    }

    let popup;

    // Tạo popup hiển thị log
    function createLogPopup(logs) {
        const oldPopup = document.getElementById('logger-popup');
        if (oldPopup) oldPopup.remove();

        popup = document.createElement('div');
        popup.id = 'logger-popup';
        popup.style.cssText = `
            position: fixed;
            bottom: 0;      /* 10px -> 0.625rem */
            right: 0;
            width: 100vw;      /* 450px -> 28.125rem */
            height: 18.75rem;  /* 300px -> 18.75rem */
            overflow-y: auto;
            background: rgba(0,0,0,0.85);
            color: #eee;
            font-family: monospace;
            font-size: 0.75rem;    /* 12px -> 0.75rem */
            padding: 0.625rem;     /* 10px -> 0.625rem */
            border-radius: 0.3125rem; /* 5px -> 0.3125rem */
            z-index: 9999;
            box-shadow: 0 0 0.625rem #000; /* 0 0 10px */
            display: flex;
            flex-direction: column;
        `;

        logs.forEach(log => {
            const line = document.createElement('div');
            line.innerHTML = `[${log.timestamp}] <span style="color: ${MAP_COLORS[log.level.toUpperCase()]}">[${log.level.toUpperCase()}]</span> ${log.message}`;
            popup.appendChild(line);
        });

        const btnContainer = document.createElement('div');
        btnContainer.style.cssText = `
            margin-top: 0.625rem; /* 10px */
            display: flex;
            gap: 0.625rem;        /* 10px */
            justify-content: flex-end;
            position: fixed;
            bottom: 1rem;
            right: 1rem;
        `;

        const exportBtn = document.createElement('button');
        exportBtn.textContent = 'Export Excel';
        exportBtn.style.cssText = `
            background: #4caf50;
            border: none;
            color: white;
            padding: 0.3125rem 0.75rem; /* 5px 12px */
            cursor: pointer;
            border-radius: 0.1875rem;    /* 3px */
            font-size: 0.75rem;
        `;
        exportBtn.onclick = () => {
            Logger.exportToExcel();
        };

        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Đóng';
        closeBtn.style.cssText = `
            background: #ff4c4c;
            border: none;
            color: white;
            padding: 0.3125rem 0.75rem;
            cursor: pointer;
            border-radius: 0.1875rem;
            font-size: 0.75rem;
        `;
        closeBtn.onclick = closePopup;

        const clearBtn = document.createElement('button');
        clearBtn.textContent = 'Xóa';
        clearBtn.style.cssText = `
            background: #ffed4cff;
            border: none;
            color: #333;
            padding: 0.3125rem 0.75rem;
            cursor: pointer;
            border-radius: 0.1875rem;
            font-size: 0.75rem;
        `;
        clearBtn.onclick = () => {
            clearAllLogs();
            if(isOpen) {
                showLogs();
            }
        };

        btnContainer.appendChild(clearBtn);
        btnContainer.appendChild(exportBtn);
        btnContainer.appendChild(closeBtn);

        popup.appendChild(btnContainer);
        document.body.appendChild(popup);

        popup.scrollTop = popup.scrollHeight;
    }


    function closePopup() {
        popup?.remove();
        isOpen = false;
    }

    // Hiển thị popup log
    async function showLogs() {
        const logs = await getAllLogs();
        createLogPopup(logs);
        isOpen = true;
    }

    // Xuất logs ra file CSV
    function exportToCSV(logs) {
        if (!logs.length) {
            alert('Không có log để xuất.');
            return;
        }

        const headers = ['Timestamp', 'Level', 'Message'];
        const csvRows = [];
        csvRows.push(headers.join(','));

        for (const log of logs) {
            const row = [
                `"${log.timestamp}"`,
                `"${log.level.toUpperCase()}"`,
                `"${log.message.replace(/"/g, '""')}"`
            ];
            csvRows.push(row.join(','));
        }

        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `logs_${new Date().toISOString().slice(0, 10)}.csv`;
        a.style.display = 'none';

        document.body.appendChild(a);
        a.click();

        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
    }

    // Hàm export gọi khi nhấn nút export
    async function exportToExcel() {
        const logs = await getAllLogs();
        exportToCSV(logs);
    }

    // Ghi log (ra console và IndexedDB)
    async function log(level, ...args) {
        const message = args.map(arg => {
            if (typeof arg === 'object') {
                try {
                    return JSON.stringify(arg);
                } catch {
                    return String(arg);
                }
            }
            return String(arg);
        }).join(' ');

        if (console[level]) {
            // console[level](message);
        } else {
            // console.log(message);
        }

        await addLog(message, level);
        if(isOpen) {
            showLogs();
        }
    }

    // Bắt phím tắt Ctrl+L để hiện popup log
    window.addEventListener('keydown', (event) => {
        if (event.ctrlKey && event.key.toLowerCase() === 'l') {
            event.preventDefault();
            if(isOpen) {
                closePopup();
            } else {
                showLogs();
            }
        }
    });

    return {
        info: (...args) => log('info', ...args),
        warn: (...args) => log('warn', ...args),
        error: (...args) => log('error', ...args),
        debug: (...args) => log('debug', ...args),
        showLogs,
        exportToExcel,
    };
})();

window.Logger = Logger;
export default Logger;
